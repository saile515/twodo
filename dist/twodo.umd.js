(function(_,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(_=typeof globalThis<"u"?globalThis:_||self,f(_.twodo={}))})(this,function(_){"use strict";var te=Object.defineProperty;var re=(_,f,E)=>f in _?te(_,f,{enumerable:!0,configurable:!0,writable:!0,value:E}):_[f]=E;var n=(_,f,E)=>(re(_,typeof f!="symbol"?f+"":f,E),E);class f{constructor(){n(this,"id",crypto.randomUUID())}}class E{constructor(){n(this,"_entities",[]);n(this,"_components",{})}add_component(e){const t=e.constructor.name;this._components[t]||(this._components[t]=[]),this._components[t].push(e)}create_entity(e){const t=new f;return e.forEach(i=>{i.set_parent(t),this.add_component(i)}),this._entities.push(t),e}delete_entity(e){Object.entries(this._components).forEach(([t,i])=>{this._components[t]=i.filter(a=>a.parent!=e)})}query(e){const t={};this._components[e[0].name].forEach(i=>{t[i.parent.id]=[i]});for(let i of e){let a=i.name;a!=e[0].name&&this._components[a].forEach(o=>{const l=t[o.parent.id];l&&l.push(o)})}return Object.values(t).filter(i=>i.length==e.length)}}class w{constructor(){n(this,"_parent",null)}set_parent(e){this._parent||(this._parent=e)}get parent(){return this._parent}}class D{constructor(e){n(this,"_texture");n(this,"_image",new Image);n(this,"_errored",!1);this._image.src=e,this._texture=gl.createTexture(),this._image.addEventListener("onerror",()=>this._errored=!0)}handle_loaded_image(){gl.bindTexture(gl.TEXTURE_2D,this._texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST)}async init(){if(this._image.complete&&!this._errored)return this.handle_loaded_image(),Promise.resolve();if(this._errored)return Promise.reject("Image could not be loaded.");this._image.addEventListener("load",()=>(this.handle_loaded_image(),Promise.resolve())),this._image.addEventListener("error",()=>Promise.reject("Image could not be loaded"))}use(){gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this._texture)}}class M{constructor(e,t,i,a){n(this,"_vertex");n(this,"_fragment");n(this,"_attribute_keys");n(this,"_uniform_keys");n(this,"_program");n(this,"_attributes",{});n(this,"_uniforms",{});this._vertex=e,this._fragment=t,this._attribute_keys=i,this._uniform_keys=a,this._program=gl.createProgram()}async compile(){const e=gl.createShader(gl.VERTEX_SHADER);if(gl.shaderSource(e,this._vertex),gl.compileShader(e),!gl.getShaderParameter(e,gl.COMPILE_STATUS))throw console.error(gl.getShaderInfoLog(e)),gl.deleteShader(e),Error("Vertex shader failed to compile.");const t=gl.createShader(gl.FRAGMENT_SHADER);if(gl.shaderSource(t,this._fragment),gl.compileShader(t),!gl.getShaderParameter(t,gl.COMPILE_STATUS))throw console.error(gl.getShaderInfoLog(t)),gl.deleteShader(t),Error("Fragment shader failed to compile.");if(gl.attachShader(this._program,e),gl.attachShader(this._program,t),gl.linkProgram(this._program),!gl.getProgramParameter(this._program,gl.LINK_STATUS))throw Error("Shader program failed to link.");this._attribute_keys.forEach(i=>{this._attributes[i]=gl.getAttribLocation(this._program,i)}),this._uniform_keys.forEach(i=>{let a=gl.getUniformLocation(this._program,i);a&&(this._uniforms[i]=a)})}use(){gl.useProgram(this._program)}set_attribute(e,t){t.bind(),gl.vertexAttribPointer(this._attributes[e],t.components,gl.FLOAT,!1,0,0),gl.enableVertexAttribArray(this._attributes[e])}set_uniform_float(e,t,i){gl["uniform"+i+"f"](this._uniforms[e],...t)}set_uniform_int(e,t,i){gl["uniform"+i+"i"](this._uniforms[e],...t)}set_uniform_vector(e,t,i){gl["uniform"+i+"fv"](this._uniforms[e],t)}set_uniform_matrix(e,t,i){gl["uniformMatrix"+i+"fv"](this._uniforms[e],!1,t)}}function O(r){const e=r.getBoundingClientRect();r.width=e.width,r.height=e.height;const t=r.getContext("webgl2");if(!t)return alert("This browser does not support WebGL2."),1;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.clearColor(0,0,0,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0);const i=globalThis||window;i.gl=t}function G(){gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)}function Y(){gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}const H=`#version 300 es

uniform highp mat3 vp_matrix;
uniform highp mat3 model_matrix;
uniform highp float depth;

out highp vec2 texture_position;

void main(void) {
    vec2 vertex_position = vec2(0.0);
    vertex_position.x = floor(float(gl_VertexID / 2)) - 0.5;
    vertex_position.y = mod(float(gl_VertexID), 2.0) - 0.5;

    gl_Position = vec4((vp_matrix * model_matrix * vec3(vertex_position, 1.0)).xy, depth, 1.0);
    texture_position = vertex_position + vec2(0.5);
}
`,W=`#version 300 es

in highp vec2 texture_position;
uniform sampler2D sampler;

out highp vec4 frag_color;

void main(void) {
    frag_color = texture(sampler, texture_position);
}
`;let y,S=!1;class x extends w{constructor(t){super();n(this,"_texture");n(this,"_failed",!1);n(this,"_texture_ready",!1);n(this,"hidden",!1);this._texture=new D(t),this._texture.init().then(()=>{this._texture_ready=!0}).catch(()=>{this._failed=!0})}draw(){!this._texture_ready||!x.shader||(this._texture.use(),x.shader.set_uniform_int("sampler",[0],1),Y())}get failed(){return this._failed}static get shader(){if(gl){if(y&&S)return y;y&&!S||(y=new M(H,W,[],["sampler","vp_matrix","model_matrix","depth"]),y.compile().then(()=>{S=!0}))}}}var b=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)});function T(){var r=new b(9);return b!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function A(r,e){var t=e[0],i=e[1],a=e[2],o=e[3],l=e[4],s=e[5],c=e[6],u=e[7],p=e[8],v=p*l-s*u,h=-p*o+s*c,m=u*o-l*c,g=t*v+i*h+a*m;return g?(g=1/g,r[0]=v*g,r[1]=(-p*i+a*u)*g,r[2]=(s*i-a*l)*g,r[3]=h*g,r[4]=(p*t-a*c)*g,r[5]=(-s*t+a*o)*g,r[6]=m*g,r[7]=(-u*t+i*c)*g,r[8]=(l*t-i*o)*g,r):null}function j(r,e,t){var i=e[0],a=e[1],o=e[2],l=e[3],s=e[4],c=e[5],u=e[6],p=e[7],v=e[8],h=t[0],m=t[1],g=t[2],R=t[3],P=t[4],k=t[5],I=t[6],L=t[7],U=t[8];return r[0]=h*i+m*l+g*u,r[1]=h*a+m*s+g*p,r[2]=h*o+m*c+g*v,r[3]=R*i+P*l+k*u,r[4]=R*a+P*s+k*p,r[5]=R*o+P*c+k*v,r[6]=I*i+L*l+U*u,r[7]=I*a+L*s+U*p,r[8]=I*o+L*c+U*v,r}function V(r,e,t){var i=e[0],a=e[1],o=e[2],l=e[3],s=e[4],c=e[5],u=e[6],p=e[7],v=e[8],h=t[0],m=t[1];return r[0]=i,r[1]=a,r[2]=o,r[3]=l,r[4]=s,r[5]=c,r[6]=h*i+m*l+u,r[7]=h*a+m*s+p,r[8]=h*o+m*c+v,r}function K(r,e,t){var i=e[0],a=e[1],o=e[2],l=e[3],s=e[4],c=e[5],u=e[6],p=e[7],v=e[8],h=Math.sin(t),m=Math.cos(t);return r[0]=m*i+h*l,r[1]=m*a+h*s,r[2]=m*o+h*c,r[3]=m*l-h*i,r[4]=m*s-h*a,r[5]=m*c-h*o,r[6]=u,r[7]=p,r[8]=v,r}function C(r,e,t){var i=t[0],a=t[1];return r[0]=i*e[0],r[1]=i*e[1],r[2]=i*e[2],r[3]=a*e[3],r[4]=a*e[4],r[5]=a*e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r}function z(r,e){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=e[0],r[7]=e[1],r[8]=1,r}function $(r,e,t){return r[0]=2/e,r[1]=0,r[2]=0,r[3]=0,r[4]=-2/t,r[5]=0,r[6]=-1,r[7]=1,r[8]=1,r}function F(){var r=new b(2);return b!=Float32Array&&(r[0]=0,r[1]=0),r}function B(r,e){var t=new b(2);return t[0]=r,t[1]=e,t}function q(r,e,t){var i=e[0],a=e[1];return r[0]=t[0]*i+t[3]*a+t[6],r[1]=t[1]*i+t[4]*a+t[7],r}(function(){var r=F();return function(e,t,i,a,o,l){var s,c;for(t||(t=2),i||(i=0),a?c=Math.min(a*t+i,e.length):c=e.length,s=i;s<c;s+=t)r[0]=e[s],r[1]=e[s+1],o(r,r,l),e[s]=r[0],e[s+1]=r[1];return e}})();class d{constructor(e,t){n(this,"_x");n(this,"_y");this._x=e,this._y=t}get x(){return this._x}get y(){return this._y}clip_space_to_world_space(e){if(!e.active_camera)return new d(0,0);const[t,i]=e.active_camera,a=T();A(a,i.matrix);const o=T();j(o,t.projection_matrix,a);const l=T();A(l,o);const s=B(this._x,this._y),c=F();return q(c,s,l),new d(c[0],-c[1])}is_within(e,t){return e.x<=this._x&&t.x>=this._x&&e.y<=this._y&&t.y>=this._y}static sub(e,t){return new d(e.x-t.x,e.y-t.y)}static add(e,t){return new d(e.x+t.x,e.y+t.y)}}class X extends w{constructor(){super();n(this,"_matrix",T());n(this,"_position",new d(0,0));n(this,"_scale",new d(1,1));n(this,"_rotation",0);n(this,"_depth",0)}calculate_matrix(){z(this._matrix,[this._position.x,this._position.y]),K(this._matrix,this._matrix,this._rotation*Math.PI/180),C(this._matrix,this._matrix,[this._scale.x,this._scale.y])}set position(t){this._position=t,this.calculate_matrix()}set scale(t){this._scale=t,this.calculate_matrix()}set rotation(t){this._rotation=t,this.calculate_matrix()}set depth(t){this._depth=t}get position(){return this._position}get scale(){return this._scale}get rotation(){return this._rotation}get depth(){return this._depth}get matrix(){return this._matrix}}class J{constructor(){n(this,"_position",new d(0,0));n(this,"_last_position",null);n(this,"_callbacks",{left_click:[],right_click:[],middle_click:[]});window.addEventListener("mousemove",e=>{this._position=new d(e.offsetX/gl.canvas.width*2-1,e.offsetY/gl.canvas.height*2-1)}),window.addEventListener("click",e=>{switch(e.button){case 0:this._callbacks.left_click.forEach(t=>t());break;case 1:this._callbacks.right_click.forEach(t=>t());break;case 2:this._callbacks.middle_click.forEach(t=>t());break}})}clear_delta(){this._last_position=new d(this._position.x,this._position.y)}get delta(){return d.sub(this._position,this._last_position||this._position)}get position(){return this._position}register_callback(e,t){return this._callbacks[e].push(t),t}unregister_callback(e){for(let t in this._callbacks)this._callbacks[t]=this._callbacks[t].filter(i=>i!=e)}}class N{constructor(){n(this,"_mouse",new J)}get mouse(){return this._mouse}}class Q{constructor(e){n(this,"_active_camera",null);n(this,"input",new N);n(this,"ecs",new E);O(e)}set active_camera(e){this._active_camera=e}get active_camera(){return this._active_camera}draw(){if(G(),this.input.mouse.clear_delta(),!this._active_camera||!x.shader)return;x.shader.use();const e=T();A(e,this._active_camera[1].matrix);const t=T();j(t,this._active_camera[0].projection_matrix,e),x.shader.set_uniform_matrix("vp_matrix",t,3),this.ecs.query([x,X]).forEach(([i,a])=>{i.hidden||(x.shader.set_uniform_matrix("model_matrix",a.matrix,3),x.shader.set_uniform_float("depth",[a.depth],1),i.draw())})}}class Z{constructor(e={target:gl.ARRAY_BUFFER,usage:gl.STATIC_DRAW,components:2}){n(this,"_buffer");n(this,"_target");n(this,"_usage");n(this,"components");this._target=e.target,this._usage=e.usage,this.components=e.components,this._buffer=gl.createBuffer()}set(e){gl.bindBuffer(this._target,this._buffer),gl.bufferData(this._target,new Float32Array(e),this._usage,0)}get(){return this._buffer}bind(){gl.bindBuffer(this._target,this._buffer)}}class ee extends w{constructor(t,i){super();n(this,"_projection_matrix",T());this.calculate_projection_matrix(t,i)}calculate_projection_matrix(t,i){$(this._projection_matrix,t,i),V(this._projection_matrix,this._projection_matrix,[t/2,i/2]),C(this._projection_matrix,this._projection_matrix,B(t/25,-t/25))}get projection_matrix(){return this._projection_matrix}}_.Buffer=Z,_.Camera=ee,_.Component=w,_.ECS=E,_.Entity=f,_.InputManager=N,_.Scene=Q,_.Shader=M,_.Sprite=x,_.Texture=D,_.Transform=X,_.Vector2=d,Object.defineProperty(_,Symbol.toStringTag,{value:"Module"})});
