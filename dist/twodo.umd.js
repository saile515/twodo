(function(s,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(s=typeof globalThis<"u"?globalThis:s||self,f(s.twodo={}))})(this,function(s){"use strict";var ee=Object.defineProperty;var te=(s,f,v)=>f in s?ee(s,f,{enumerable:!0,configurable:!0,writable:!0,value:v}):s[f]=v;var n=(s,f,v)=>(te(s,typeof f!="symbol"?f+"":f,v),v);class f{constructor(){n(this,"id",crypto.randomUUID())}}class v{constructor(){n(this,"_entities",[]);n(this,"_components",{})}add_component(e){const r=e.constructor.name;this._components[r]||(this._components[r]=[]),this._components[r].push(e)}create_entity(e){const r=new f;return e.forEach(i=>{i.set_parent(r),this.add_component(i)}),this._entities.push(r),e}query(e){const r={};this._components[e[0].name].forEach(i=>{r[i.parent.id]=[i]});for(let i of e){let a=i.name;a!=e[0].name&&this._components[a].forEach(_=>{const l=r[_.parent.id];l&&l.push(_)})}return Object.values(r).filter(i=>i.length==e.length)}}class b{constructor(){n(this,"_parent",null)}set_parent(e){this._parent||(this._parent=e)}get parent(){return this._parent}}class D{constructor(e){n(this,"_texture");n(this,"_image",new Image);n(this,"_errored",!1);this._image.src=e,this._texture=gl.createTexture(),this._image.addEventListener("onerror",()=>this._errored=!0)}handle_loaded_image(){gl.bindTexture(gl.TEXTURE_2D,this._texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this._image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST)}async init(){if(this._image.complete&&!this._errored)return this.handle_loaded_image(),Promise.resolve();if(this._errored)return Promise.reject("Image could not be loaded.");this._image.addEventListener("load",()=>(this.handle_loaded_image(),Promise.resolve())),this._image.addEventListener("error",()=>Promise.reject("Image could not be loaded"))}use(){gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this._texture)}}class M{constructor(e,r,i,a){n(this,"_vertex");n(this,"_fragment");n(this,"_attribute_keys");n(this,"_uniform_keys");n(this,"_program");n(this,"_attributes",{});n(this,"_uniforms",{});this._vertex=e,this._fragment=r,this._attribute_keys=i,this._uniform_keys=a,this._program=gl.createProgram()}async compile(){const e=gl.createShader(gl.VERTEX_SHADER);if(gl.shaderSource(e,this._vertex),gl.compileShader(e),!gl.getShaderParameter(e,gl.COMPILE_STATUS))throw console.error(gl.getShaderInfoLog(e)),gl.deleteShader(e),Error("Vertex shader failed to compile.");const r=gl.createShader(gl.FRAGMENT_SHADER);if(gl.shaderSource(r,this._fragment),gl.compileShader(r),!gl.getShaderParameter(r,gl.COMPILE_STATUS))throw console.error(gl.getShaderInfoLog(r)),gl.deleteShader(r),Error("Fragment shader failed to compile.");if(gl.attachShader(this._program,e),gl.attachShader(this._program,r),gl.linkProgram(this._program),!gl.getProgramParameter(this._program,gl.LINK_STATUS))throw Error("Shader program failed to link.");this._attribute_keys.forEach(i=>{this._attributes[i]=gl.getAttribLocation(this._program,i)}),this._uniform_keys.forEach(i=>{let a=gl.getUniformLocation(this._program,i);a&&(this._uniforms[i]=a)})}use(){gl.useProgram(this._program)}set_attribute(e,r){r.bind(),gl.vertexAttribPointer(this._attributes[e],r.components,gl.FLOAT,!1,0,0),gl.enableVertexAttribArray(this._attributes[e])}set_uniform_float(e,r,i){gl["uniform"+i+"f"](this._uniforms[e],...r)}set_uniform_int(e,r,i){gl["uniform"+i+"i"](this._uniforms[e],...r)}set_uniform_vector(e,r,i){gl["uniform"+i+"fv"](this._uniforms[e],r)}set_uniform_matrix(e,r,i){gl["uniformMatrix"+i+"fv"](this._uniforms[e],!1,r)}}function B(t){const e=t.getBoundingClientRect();t.width=e.width,t.height=e.height;const r=t.getContext("webgl2");if(!r)return alert("This browser does not support WebGL2."),1;r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.clearColor(0,0,0,1);const i=globalThis||window;i.gl=r}function X(){gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)}function N(){gl.drawArrays(gl.TRIANGLE_STRIP,0,4)}const O=`#version 300 es

uniform highp mat3 vp_matrix;
uniform highp mat3 model_matrix;
uniform highp float depth;

out highp vec2 texture_position;

void main(void) {
    vec2 vertex_position = vec2(0.0);
    vertex_position.x = floor(float(gl_VertexID / 2)) - 0.5;
    vertex_position.y = mod(float(gl_VertexID), 2.0) - 0.5;

    gl_Position = vec4((vp_matrix * model_matrix * vec3(vertex_position, 1.0)).xy, depth, 1.0);
    texture_position = vertex_position + vec2(0.5);
}
`,G=`#version 300 es

in highp vec2 texture_position;
uniform sampler2D sampler;

out highp vec4 frag_color;

void main(void) {
    frag_color = texture(sampler, texture_position);
}
`;let T,A=!1;class p extends b{constructor(r){super();n(this,"_texture");n(this,"_failed",!1);n(this,"_texture_ready",!1);this._texture=new D(r),this._texture.init().then(()=>{this._texture_ready=!0}).catch(()=>{this._failed=!0})}draw(){!this._texture_ready||!p.shader||(this._texture.use(),p.shader.set_uniform_int("sampler",[0],1),N())}get failed(){return this._failed}static get shader(){if(gl){if(T&&A)return T;T&&!A||(T=new M(O,G,[],["sampler","vp_matrix","model_matrix","depth"]),T.compile().then(()=>{A=!0}))}}}class x{constructor(e,r){n(this,"_x");n(this,"_y");this._x=e,this._y=r}get x(){return this._x}get y(){return this._y}static sub(e,r){return new x(e.x-r.x,e.y-r.y)}static add(e,r){return new x(e.x+r.x,e.y+r.y)}}var y=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function S(){var t=new y(9);return y!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function k(t,e){var r=e[0],i=e[1],a=e[2],_=e[3],l=e[4],o=e[5],h=e[6],u=e[7],d=e[8],E=d*l-o*u,c=-d*_+o*h,m=u*_-l*h,g=r*E+i*c+a*m;return g?(g=1/g,t[0]=E*g,t[1]=(-d*i+a*u)*g,t[2]=(o*i-a*l)*g,t[3]=c*g,t[4]=(d*r-a*h)*g,t[5]=(-o*r+a*_)*g,t[6]=m*g,t[7]=(-u*r+i*h)*g,t[8]=(l*r-i*_)*g,t):null}function V(t,e,r){var i=e[0],a=e[1],_=e[2],l=e[3],o=e[4],h=e[5],u=e[6],d=e[7],E=e[8],c=r[0],m=r[1],g=r[2],R=r[3],w=r[4],P=r[5],I=r[6],U=r[7],L=r[8];return t[0]=c*i+m*l+g*u,t[1]=c*a+m*o+g*d,t[2]=c*_+m*h+g*E,t[3]=R*i+w*l+P*u,t[4]=R*a+w*o+P*d,t[5]=R*_+w*h+P*E,t[6]=I*i+U*l+L*u,t[7]=I*a+U*o+L*d,t[8]=I*_+U*h+L*E,t}function H(t,e,r){var i=e[0],a=e[1],_=e[2],l=e[3],o=e[4],h=e[5],u=e[6],d=e[7],E=e[8],c=r[0],m=r[1];return t[0]=i,t[1]=a,t[2]=_,t[3]=l,t[4]=o,t[5]=h,t[6]=c*i+m*l+u,t[7]=c*a+m*o+d,t[8]=c*_+m*h+E,t}function Y(t,e,r){var i=e[0],a=e[1],_=e[2],l=e[3],o=e[4],h=e[5],u=e[6],d=e[7],E=e[8],c=Math.sin(r),m=Math.cos(r);return t[0]=m*i+c*l,t[1]=m*a+c*o,t[2]=m*_+c*h,t[3]=m*l-c*i,t[4]=m*o-c*a,t[5]=m*h-c*_,t[6]=u,t[7]=d,t[8]=E,t}function j(t,e,r){var i=r[0],a=r[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=a*e[3],t[4]=a*e[4],t[5]=a*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function W(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function z(t,e,r){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function K(){var t=new y(2);return y!=Float32Array&&(t[0]=0,t[1]=0),t}function $(t,e){var r=new y(2);return r[0]=t,r[1]=e,r}(function(){var t=K();return function(e,r,i,a,_,l){var o,h;for(r||(r=2),i||(i=0),a?h=Math.min(a*r+i,e.length):h=e.length,o=i;o<h;o+=r)t[0]=e[o],t[1]=e[o+1],_(t,t,l),e[o]=t[0],e[o+1]=t[1];return e}})();class C extends b{constructor(){super();n(this,"_matrix",S());n(this,"_position",new x(0,0));n(this,"_scale",new x(1,1));n(this,"_rotation",0);n(this,"_depth",0)}calculate_matrix(){W(this._matrix,[this._position.x,this._position.y]),Y(this._matrix,this._matrix,this._rotation*Math.PI/180),j(this._matrix,this._matrix,[this._scale.x,this._scale.y])}set position(r){this._position=r,this.calculate_matrix()}set scale(r){this._scale=r,this.calculate_matrix()}set rotation(r){this._rotation=r,this.calculate_matrix()}set depth(r){this._depth=r}get position(){return this._position}get scale(){return this._scale}get rotation(){return this._rotation}get depth(){return this._depth}get matrix(){return this._matrix}}class q{constructor(){n(this,"_position",new x(0,0));n(this,"_last_position",null);window.addEventListener("mousemove",e=>{this._position=new x(e.offsetX,e.offsetY)})}clear_delta(){this._last_position=new x(this._position.x,this._position.y)}get delta(){return x.sub(this._position,this._last_position||this._position)}}class F{constructor(){n(this,"_mouse",new q)}get mouse(){return this._mouse}}class J{constructor(e){n(this,"_active_camera",null);n(this,"input",new F);n(this,"ecs",new v);B(e)}set_active_camera(e){this._active_camera=e}draw(){if(X(),!this._active_camera||!p.shader)return;p.shader.use();const e=S();k(e,this._active_camera[1].matrix);const r=S();V(r,this._active_camera[0].projection_matrix,e),p.shader.set_uniform_matrix("vp_matrix",r,3),this.ecs.query([p,C]).forEach(([i,a])=>{p.shader.set_uniform_matrix("model_matrix",a.matrix,3),p.shader.set_uniform_float("depth",[a.depth],1),i.draw()})}}class Q{constructor(e={target:gl.ARRAY_BUFFER,usage:gl.STATIC_DRAW,components:2}){n(this,"_buffer");n(this,"_target");n(this,"_usage");n(this,"components");this._target=e.target,this._usage=e.usage,this.components=e.components,this._buffer=gl.createBuffer()}set(e){gl.bindBuffer(this._target,this._buffer),gl.bufferData(this._target,new Float32Array(e),this._usage,0)}get(){return this._buffer}bind(){gl.bindBuffer(this._target,this._buffer)}}class Z extends b{constructor(r,i){super();n(this,"_projection_matrix",S());this.calculate_projection_matrix(r,i)}calculate_projection_matrix(r,i){z(this._projection_matrix,r,i),H(this._projection_matrix,this._projection_matrix,[r/2,i/2]),j(this._projection_matrix,this._projection_matrix,$(r/25,r/25))}get projection_matrix(){return this._projection_matrix}}s.Buffer=Q,s.Camera=Z,s.Component=b,s.ECS=v,s.Entity=f,s.InputManager=F,s.Scene=J,s.Shader=M,s.Sprite=p,s.Texture=D,s.Transform=C,s.Vector2=x,Object.defineProperty(s,Symbol.toStringTag,{value:"Module"})});
